name: release

on:
  push:
    branches:
      - "**"
    tags-ignore:
      - "sfs-*"
  pull_request:

env:
  CRATE_NAME: sfs
  GITHUB_TOKEN: ${{ github.token }}
  RUST_BACKTRACE: 1

jobs:
    release:
        name: Release - ${{ matrix.platform.os-name }}
        strategy:
            matrix:
                platform:
                    - os-name: Linux-x86_64
                      runs-on: ubuntu-latest
                      target: x86_64-unknown-linux-musl
                    - os-name: Linux-aarch64
                      runs-on: ubuntu-latest
                      target: aarch64-unknown-linux-musl
                    - os-name: Linux-riscv64
                      runs-on: ubuntu-latest
                      target: riscv64gc-unknown-linux-gnu

                    - os-name: Windows-x86_64
                      runs-on: windows-latest
                      target: x86_64-pc-windows-msvc
                    - os-name: Windows-aarch64
                      runs-on: windows-latest
                      target: aarch64-pc-windows-msvc

                    - os-name: macOS-x86_64
                      runs-on: macos-latest
                      target: x86_64-apple-darwin
                    - os-name: macOS-aarch64
                      runs-on: macos-latest
                      target: aarch64-apple-darwin
                toolchain:
                  - stable
        runs-on: ${{ matrix.platform.runs-on }}
        steps:
            - name: Checkout
              uses: actions/checkout@v4
            - name: Build binary
              uses: houseabsolute/actions-rust-cross@v1
              with:
                  command: build
                  target: ${{ matrix.platform.target }}
                  args: "--locked --release"
                  strip: true
            - name: Publish artifacts and release
              uses: houseabsolute/actions-rust-release@v0
              with:
                  executable-name: sfs
                  target: ${{ matrix.platform.target }}
                  extra-files: example.env
              if: matrix.toolchain == 'stable'
